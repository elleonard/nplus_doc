---
title: Amazonのバグを踏んで勇者ネプテューヌの配送が年末にずれ込みそうだった話
category: 雑記
date: 2018-12-20 11:19:33
tags:
---


# 概要

マジでタイトルの通りなんですが、あくまで珍しい体験をしたという話であって、特定のサービスや商品、企業に対して怒りを感じているという趣旨ではありません。

<!-- more -->

# 一通のメールから発覚

12/19の朝、筆者宛に一通のメールが届きました。
`クレジットカードの利用承認が得られませんでした` とかいう、送り主が違えば完全にスパム扱いなタイトルで送られてくるのはどうよという気もしますが、メール内のリンクを踏まずに該当サービスを別にブラウザで開く習慣のついている筆者にとって、こういった形式のメールは特に脅威になりません。

今回も不穏なメールタイトルにビビりながらブラウザでAmazonを開いて注文履歴を確認。
未発送の注文の中にいました。勇ネプ。

{% amazon "https://www.amazon.co.jp/dp/B07CNHWD41?tag=false" "https://images-fe.ssl-images-amazon.com/images/I/61jf9DIVniL._SL200_.jpg" "勇者ネプテューヌ 世界よ宇宙よ刮目せよ! ! アルティメットRPG宣言! ! - PS4" 2018-12-20 %}
Re;birth1+を購入した際に、まとめて予約していたんでした。半年以上前のことだったんですっかり記憶の彼方です。

勇ネプの注文ログに、お支払い方法の変更が必要です。と赤文字でデカデカと表記されていました。
思い当たるとすれば、5月にメインで使うクレジットカードをVisaからMasterのものに変えたということくらい。
変えた際にミス防止のため、古いカードの情報をアカウントから抹消したので、null参照っぽく落ちてしまったんだろうと深いこと考えずに、支払い方法の変更ボタンから現在利用しているカードを選択しました。

ところが

# 利用承認、得られません……ッ！

入力直後にも全く同じ内容のメールが届きました。
なにかの間違いだろうと再度入力したところその日は音沙汰がなくなったのですが、翌日（12/20）の朝にもまた同じ内容のメールが。
いや待ってよ発売日だよ？ 半年以上前から予約してたんだよ？
と混乱しつつ状況確認。昨日と全く変わっていません。

おかしい、何かが起こっているに違いない。

# 原因はどこだ

おそらく、カードの利用承認を含む決済はざっくり以下のようなフローで行われていると思われます。

1. 予約していた商品の決済タイミングになる
2. Amazonからカード会社へ利用承認申請する
3. カード会社が利用承認する
4. 決済完了

こういう状況でまず疑うのは2と3の間。カード会社側でなにか起きていないか、ということです。
利用限度額に達していたり、短時間に大量の決済を走らせるとセーフティがはたらいてカードが一時的に止められたりするので、まずはそこ。
水着ジャンヌで大敗北した8月ならまだしも、今月は特に（主に飲み会関係の）出費が多いためカードの利用は控えていました。
利用限度額には程遠く、利用明細にも不審なログはありません。

カード会社でなにか不手際がなかったかと電話で問い合わせてみます。

## カード会社への問い合わせ

決済の金額とタイミングを伝え、調査してもらうことにしました。
が、その取引について利用承認申請すら来ていないとの回答。

かなり親切に調査・回答していただきました。追加調査を行って折返し連絡します、と言われ、その場では電話を切ることに。

しかし、利用承認の申請がカード会社に届いていないとなると、先程のフローの2と3の間に原因がなく、むしろ1と2のどこかでコケていることになります。
つまり、Amazon側で何かが起こっているのではないか、ということです。

## Amazonカスタマーセンターへの問い合わせ

カード会社の問い合わせ担当のお姉さんと同じく、Amazonカスタマーセンターのお兄さんも、口下手な筆者の問い合わせにとても親切に答えてくれました。

なんやかんやとやり取りをした結果、「もう一度注文してみてくれませんか」ということだったので、再度注文ボタンからもう一度注文してみました。
しばらく待つと、再度注文する前のものと再度注文した後のもの両方にカードの利用承認が降りました。

こうなると気になるのは配送時期です。発売日の朝にこんな作業をしていたら、当日に届けろなんて無茶は言えません。
とはいえ半年以上前に予約していた商品であるのも事実。表示上明日（21日）に届くという感じだったが、もはやイレギュラーな事態が起きていることを確信した筆者は恐る恐るお兄さんに確認を取ります。

「これ商品が届くのは表示によると21日なんですけど」
「ごめんなさい。バグってて多分30日のほうになるかと」

なるほど？

# 何が原因だったのか

ここからは推測です。

おそらく、カード会社側は何もこの問題に関与していません。（利用承認の申請がAmazonから届かないのだから当然ですね）
Amazonからの利用承認の申請が届かなかったのは、おそらく古いカード情報を参照し続けていたからだと思います。

古いカード情報はカードを変更したときに削除したはずでは？ と思うかもしれません。
ただ、Re;birth1+の決済は5月末に古いカードで行われていて、その際の利用承認申請は古いカードのほうのカード会社へ飛んでいるはずです。
もしその利用申請先の情報がキャッシュされていたとしたら、最初に承認が降りなかったのはある意味自然な流れではあります。

新しいカードを選択して支払い方法を変更した後にも古いカードの会社へ申請が飛んでしまったのだとすると、これはバグです。
（そして、新しいカードの会社に利用承認申請が来ていなかったことから考えて、このケースに該当する可能性は濃厚です）

手順が複雑すぎて再現はしたくないですが、今回の流れは以下のような感じ。

1. カードAで発売時期の違う商品A, 商品Bを同時に予約する（商品AはカードAの期限内、商品BはカードAの利用期限の後に発売する）
2. 商品Aの決済が通った後でカードAの情報をアカウントから削除する
3. カードBの情報をアカウントに登録する
4. 商品Bについてカードの利用承認が得られなかった旨の通知が来たら、支払い方法の変更でカードBを利用するように設定する

本来は2の段階でカードAの情報が消えるべきで、UI上も支払い方法の変更が必要である旨を表示してくれるほうが親切。
そして、4の後にカードAの会社に利用承認の申請を出してしまうのは明らかなバグなので、おそらく注文単位でキャッシュされているであろうカード会社の情報を遅くともこのタイミングでは揮発させないといけないはずです。

とはいえ、Amazonほど巨大かつ長期間運用されているシステムは裏側までよっぽどうまく作られていないとなかなか手を加えられないものなので、こういうコーナーケースの修正はなかなかされない気もしますが。

# konozamaだよ！！

ともあれ、カスタマーセンターのお兄さんの話によれば、勇ネプの配送は年末にずれ込みそうです。
半年前に予約したにも関わらず、というのはなかなか納得しにくい話ではありますが、カード情報変更の際に過去の予約注文に影響があることは予想されてしかるべきだったので、筆者の落ち度でもあります。

過去幾度かkonozamaされていますが、実はもうあんまり気にならないというのも事実だったりします。
今回の件も冒頭で書いた通り、珍しい経験をしたな、くらいの気分です。

いや、だってリディー＆スールのアトリエ終わってないし……。

# 2018/12/20 深夜追記

普通に21日着の発送メール来てたんで、30日になるはお兄さんの勘違いっぽそうです。
良かった良かった……のか？ 結局アトリエ終わってないからどっちにしても変わらない気がするけど。
